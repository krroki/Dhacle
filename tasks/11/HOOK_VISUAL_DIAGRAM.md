# 🎨 Hook System 시각적 작동 다이어그램

## 🔄 전체 작동 흐름도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Claude Code 작업 흐름                          │
└─────────────────────────────────────────────────────────────────────────┘

     👤 사용자                    🤖 Claude Code                 📁 파일시스템
        │                              │                              │
        │  "코드 수정해줘"              │                              │
        ├──────────────────────────────>                              │
        │                              │                              │
        │                         [코드 분석]                         │
        │                              │                              │
        │                         [수정 계획]                         │
        │                              │                              │
        │                    ╔═══════════════════╗                    │
        │                    ║  Write/Edit 시도  ║                    │
        │                    ╚════════╤══════════╝                    │
        │                              │                              │
        │                              ▼                              │
        │                    ┌─────────────────┐                      │
        │                    │   Hook System   │ ← 50ms 이하          │
        │                    │  (PreToolUse)   │                      │
        │                    └────────┬────────┘                      │
        │                              │                              │
        │                    ┌─────────▼──────────┐                   │
        │                    │   3개 Validator    │                   │
        │                    │  ✓ any-type       │                   │
        │                    │  ✓ todo-comments  │                   │
        │                    │  ✓ empty-catch    │                   │
        │                    └─────────┬──────────┘                   │
        │                              │                              │
        │                         검증 결과?                          │
        │                              │                              │
        │              ┌───────────────┼───────────────┐              │
        │              ▼                               ▼              │
        │         [✅ 통과]                      [❌ 차단]            │
        │              │                               │              │
        │              │                    ┌──────────────────┐      │
        │              │                    │  차단 메시지 반환 │      │
        │              │                    │  "TODO 발견됨"   │      │
        │              │                    └──────────┬───────┘      │
        │              │                               │              │
        │              │                         [코드 재작성]        │
        │              │                               │              │
        │              │                         [다시 시도]          │
        │              │                               │              │
        │              └───────────────┬───────────────┘              │
        │                              │                              │
        │                              ▼                              │
        │                         파일 수정 실행 ─────────────────────>│
        │                              │                              │
        │  "수정 완료!"                │                              │
        │<─────────────────────────────┘                              │
        │                                                             │
```

## 📊 Context 격리 구조

```
┌──────────────────────────────────────────────────────────────────┐
│                      Claude Code Process                         │
│  ┌────────────────────────────────────────────────────────┐     │
│  │  Claude의 메모리 공간                                    │     │
│  │  • 사용자 대화 컨텍스트 ████████████████               │     │
│  │  • 코드 분석 결과       ████████████                   │     │
│  │  • 작업 계획           ███████                        │     │
│  │  • Hook 존재 모름      (인지 없음)                     │     │
│  └────────────────────────────────────────────────────────┘     │
│                              │                                   │
│                              │ JSON 통신                         │
│                              ▼                                   │
└──────────────────────────────┼───────────────────────────────────┘
                               │
                    ╔══════════╧══════════╗
                    ║   외부 프로세스      ║
                    ║  ┌────────────────┐ ║
                    ║  │  Hook System   │ ║ ← 독립 메모리
                    ║  │  (Node.js)     │ ║ ← 5초 timeout
                    ║  │  • Stateless   │ ║ ← 매번 새 실행
                    ║  └────────────────┘ ║
                    ╚══════════════════════╝
```

## 🚦 의사결정 플로우

```
                        파일 수정 요청
                             │
                             ▼
                    ┌─────────────────┐
                    │  도구 타입 확인   │
                    └─────────┬────────┘
                             │
                 Write/Edit/MultiEdit?
                    ┌────────┴────────┐
                    │                 │
                   Yes               No → [즉시 통과]
                    │
                    ▼
            ┌──────────────┐
            │ Hook 활성화? │
            └──────┬───────┘
                   │
        ┌──────────┼──────────┐
        │                     │
       Yes                   No → [즉시 통과]
        │
        ▼
   ╔═══════════════════════════════╗
   ║      Validator 순차 실행        ║
   ╟───────────────────────────────╢
   ║ 1. any-type 검사              ║
   ║    ├─ 패턴: /:\s*any/         ║
   ║    └─ 위반 시 → violations[]  ║
   ║                               ║
   ║ 2. TODO/FIXME 검사            ║
   ║    ├─ 패턴: /TODO|FIXME/      ║
   ║    └─ 위반 시 → violations[]  ║
   ║                               ║
   ║ 3. Empty catch 검사           ║
   ║    ├─ 패턴: catch 블록 분석    ║
   ║    └─ 위반 시 → violations[]  ║
   ╚═══════════╤══════════════════╝
               │
          violations > 0?
               │
      ┌────────┴────────┐
      │                 │
     Yes               No
      │                 │
      ▼                 ▼
  ┌────────┐      ┌────────┐
  │  차단   │      │  통과   │
  └────────┘      └────────┘
      │                 │
      ▼                 ▼
  return {          exit(0)
    decision: "block",
    reason: "..."
  }
```

## ⏱️ 시간 영향 비교

```
일반 작업 (Hook 없음):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 1000ms

Hook 포함 작업:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━▌ 1045ms
                                                      └─ Hook (45ms)

차단 후 재작성:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━▌━━━━━━━━━━━ 3045ms
                                                      └ Hook  └ 재작성 (2000ms)

실제 영향:
• 정상 작업: +4.5% 시간 (무시 가능)
• 차단 발생: +200% 시간 (하지만 품질 향상)
```

## 🛡️ 안전 메커니즘

```
                  Hook 실행
                      │
                      ▼
              ┌──────────────┐
              │  시작 타이머   │
              └───────┬──────┘
                      │
                ┌─────▼─────┐
                │  검증 실행  │
                └─────┬─────┘
                      │
                 5초 경과?
                ┌─────┴─────┐
                │           │
               Yes         No
                │           │
                ▼           ▼
          ┌──────────┐ ┌─────────┐
          │ Timeout! │ │ 결과반환 │
          │ 자동통과  │ └─────────┘
          └──────────┘

        Hook 실패 = 작업 계속
        (Claude에게 영향 없음)
```

## 💬 실제 상호작용 예시

```
┌────────────────────────────────────────────────────────┐
│ 👤 사용자: "getData 함수 빨리 만들어줘"                  │
└────────────────────────────────────────────────────────┘
                         ▼
┌────────────────────────────────────────────────────────┐
│ 🤖 Claude: "네, getData 함수를 만들겠습니다"             │
│                                                        │
│ [내부 사고]                                            │
│ • 빠르게 작성해야 함                                    │
│ • 일단 any로 타입 처리                                  │
│ • TODO로 나중에 완성 표시                               │
└────────────────────────────────────────────────────────┘
                         ▼
┌────────────────────────────────────────────────────────┐
│ 📝 첫 번째 시도:                                       │
│ function getData(): any {                             │
│   // TODO: implement later                            │
│   return null;                                        │
│ }                                                      │
└────────────────────────────────────────────────────────┘
                         ▼
┌────────────────────────────────────────────────────────┐
│ 🚨 Hook 차단!                                          │
│ ❌ TypeScript "any" Usage: Line 1                     │
│ ❌ TODO/FIXME Comments: Line 2                        │
└────────────────────────────────────────────────────────┘
                         ▼
┌────────────────────────────────────────────────────────┐
│ 🤖 Claude: [차단 인식 - 재작성]                        │
│                                                        │
│ [내부 조정]                                            │
│ • any 대신 구체적 타입 사용                            │
│ • TODO 제거하고 완전 구현                              │
└────────────────────────────────────────────────────────┘
                         ▼
┌────────────────────────────────────────────────────────┐
│ 📝 두 번째 시도:                                       │
│ interface DataResponse {                              │
│   data: unknown;                                      │
│   error?: Error;                                      │
│ }                                                      │
│                                                        │
│ async function getData(): Promise<DataResponse> {     │
│   try {                                               │
│     const response = await fetch('/api/data');        │
│     return { data: await response.json() };           │
│   } catch (error) {                                   │
│     console.error('Failed:', error);                  │
│     return { data: null, error: error as Error };     │
│   }                                                   │
│ }                                                      │
└────────────────────────────────────────────────────────┘
                         ▼
┌────────────────────────────────────────────────────────┐
│ ✅ Hook 통과!                                          │
└────────────────────────────────────────────────────────┘
                         ▼
┌────────────────────────────────────────────────────────┐
│ 🤖 Claude: "getData 함수를 완성했습니다.               │
│            에러 처리도 포함되어 있습니다."              │
└────────────────────────────────────────────────────────┘
```

## 🎯 핵심 포인트

```
╔════════════════════════════════════════════════════════╗
║              Hook System 핵심 특징                      ║
╠════════════════════════════════════════════════════════╣
║                                                        ║
║  1. 투명성 (Transparent)                              ║
║     • Claude는 Hook 존재를 모름                        ║
║     • 차단 시에만 메시지로 인지                        ║
║                                                        ║
║  2. 비침투성 (Non-invasive)                           ║
║     • Context 오염 없음                                ║
║     • 메모리 공유 없음                                 ║
║     • 독립 프로세스 실행                               ║
║                                                        ║
║  3. 안전성 (Safe)                                     ║
║     • Timeout 자동 통과                                ║
║     • 실패 시 작업 계속                                ║
║     • Emergency disable 가능                           ║
║                                                        ║
║  4. 효율성 (Efficient)                                ║
║     • 평균 45ms 실행                                   ║
║     • 1.7% 미만 성능 영향                              ║
║     • 캐싱 없이도 빠름                                 ║
║                                                        ║
╚════════════════════════════════════════════════════════╝
```

---

*시각화 완료: Hook System은 Claude Code 작업을 방해하지 않으면서 품질을 향상시킵니다.*