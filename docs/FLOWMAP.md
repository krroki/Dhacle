# 🗺️ 디하클 사용자 플로우맵

*목적: 페이지 간 이동과 인증 흐름*
*핵심 질문: "사용자가 어떻게 이동하지?"*
*최종 업데이트: 2025-01-31 - DOCUMENT_GUIDE 지침 반영*

---

## 🔐 인증 플로우

### 시나리오 1: 미인증 → 보호 페이지 (운영 환경)
```
사용자 → /tools/youtube-lens 클릭
    ↓
[401 응답 감지]
    ↓
자동 리다이렉트 → /auth/login
    ↓
카카오 로그인 성공
    ↓
원래 페이지로 복귀 (/tools/youtube-lens)
```

### 🧪 시나리오 1-DEV: 개발/테스트 환경 로그인 (2025-08-29 업데이트)
```
개발자/테스트 → /auth/login 접근
    ↓
[localhost 환경 감지]
    ↓
"🧪 테스트 로그인 (localhost 전용)" 버튼 표시
    ↓
테스트 로그인 클릭 → /api/auth/test-login 호출
    ↓
[Supabase Admin API로 테스트 계정 자동 생성/관리]
    ↓
실제 Supabase 인증 (signInWithPassword) 수행
    ↓
세션 쿠키 설정 (sb-access-token, sb-refresh-token)
    ↓
즉시 인증 완료 → /tools/youtube-lens 리다이렉트
    ↓
[YouTube API 키 자동 설정 (개발 환경만)]
```

**구현 상세**:
- 테스트 계정: test-admin@dhacle.com (자동 생성)
- 실제 Supabase 인증 사용 (fake 세션 아님)
- YouTube API 키 자동 프로비저닝 (localhost만)
- E2E 테스트 완전 지원

### 시나리오 2: 세션 만료
```
작업 중 → 세션 만료 (24시간)
    ↓
API 401 응답
    ↓
Toast: "세션이 만료되었습니다"
    ↓
3초 후 → /auth/login
```

---

## 🚨 E2E 테스트 에러 감지 플로우
*추가: 2025-01-31*

### 시나리오 3: 런타임 에러 발생 시 (E2E 테스트)
```
E2E 테스트 실행 → 페이지 로드
    ↓
[console.error 감지]
    ↓
ErrorDetector 즉시 캐치
    ↓
스크린샷 자동 저장
    ↓
테스트 중단 → 에러 리포트 생성
```

### 시나리오 4: Next.js 에러 오버레이 (개발 모드)
```
개발 모드 테스트 → JavaScript 에러 발생
    ↓
[Next.js 에러 오버레이 표시]
    ↓
data-nextjs-dialog 감지
    ↓
에러 컨텍스트 수집
    ↓
테스트 실패 처리 → 상세 로그 출력
```

### 시나리오 5: Error Boundary 활성화
```
React 컴포넌트 에러 → Error Boundary 캐치
    ↓
[에러 화면 표시]
    ↓
role="alert" 요소 감지
    ↓
에러 메시지 추출
    ↓
테스트 중단 → 복구 불가 판단
```

---

## 📍 페이지별 접근 권한

| 페이지 경로 | 인증 필요 | 401 동작 | 구현 상태 |
|------------|----------|----------|----------|
| `/` (홈) | ❌ | - | ✅ |
| `/courses` | ❌ | - | ✅ |
| `/courses/[id]` | ❌ | - | ✅ |
| `/auth/login` | ❌ | - | ✅ |
| `/tools/youtube-lens` | ✅ | → 로그인 | ❌ |
| `/tools/youtube-lens/popular` | ✅ | → 로그인 | ❌ |
| `/tools/youtube-lens/collections` | ✅ | → 로그인 | ❌ |
| `/mypage` | ✅ | → 로그인 | ❌ |
| `/mypage/profile` | ✅ | → 로그인 | ❌ |
| `/mypage/courses` | ✅ | → 로그인 | ❌ |
| `/revenue-proof` | ✅ | → 로그인 | ⚠️ |
| `/community` | ⚠️ | 읽기만 가능 | ⚠️ |
| `/admin/*` | ✅ | → 403 페이지 | ❌ |
| `/settings/api-keys` | ✅ | → 로그인 | ❌ |
| `/payment/success` | ✅ | → 홈 | ⚠️ |
| `/payment/fail` | ✅ | → 홈 | ⚠️ |

---

## 🔄 주요 사용자 플로우

### 1. YouTube Lens 첫 사용
```
홈 → YouTube Lens 클릭
  ↓
[미인증] → 로그인 페이지
  ↓
카카오 로그인
  ↓
[API Key 없음] → API Key 설정 모달
  ↓
API Key 입력
  ↓
YouTube Lens 사용 시작
```

### 2. 강의 구매 플로우
```
강의 목록 → 강의 상세
  ↓
"수강 신청" 클릭
  ↓
[미인증] → 로그인 → 원래 페이지
[인증됨] → 결제 페이지
  ↓
TossPayments 결제
  ↓
성공: /payment/success → 강의 시청
실패: /payment/fail → 재시도
```

### 3. 수익 인증 작성
```
수익 인증 목록 → "작성" 버튼
  ↓
[미인증] → 로그인
  ↓
수익 인증 폼
  ↓
이미지 업로드 + 내용 작성
  ↓
제출 → 목록으로
```

### 4. 커뮤니티 활동
```
커뮤니티 게시글 목록 (누구나)
  ↓
게시글 읽기 (누구나)
  ↓
"댓글 작성" 클릭
  ↓
[미인증] → 로그인 필요 모달
  ↓
로그인 → 댓글 작성
```

---

## 🚨 에러 시나리오별 처리

### 네트워크 에러
```
API 요청 → Network Error
  ↓
Toast: "네트워크 연결을 확인해주세요"
  ↓
Retry 버튼 표시
```

### 권한 없음 (403)
```
관리자 페이지 접근 → 403
  ↓
Toast: "접근 권한이 없습니다"
  ↓
이전 페이지로 돌아가기
```

### 서버 에러 (500)
```
API 요청 → 500 Error
  ↓
Toast: "일시적인 오류가 발생했습니다"
  ↓
자동 재시도 (3회)
  ↓
실패 시 → 고객센터 안내
```

### E2E 테스트 런타임 에러 (2025-08-27 추가)
```
E2E 테스트 실행 중 → JavaScript 에러 발생
  ↓
[기존: 에러 무시하고 계속 진행]
  ↓
잘못된 테스트 결과 ("통과"로 표시)

[개선: ErrorDetector 시스템]
  ↓
에러 즉시 감지 (console/page/web error)
  ↓
테스트 즉시 중단
  ↓
에러 컨텍스트 기록 (URL, 액션, 시간)
  ↓
스크린샷 자동 저장
  ↓
정확한 실패 원인 제공
```

### Next.js 개발 모드 에러
```
개발 중 → 런타임 에러 발생
  ↓
Next.js 에러 오버레이 표시
  ↓
[E2E 테스트가 감지해야 할 요소]
- [data-nextjs-dialog] 엘리먼트
- Hydration 에러 메시지
- React Error Boundary 활성화
  ↓
ErrorDetector가 자동 감지
  ↓
테스트 실패 + 상세 리포트
```

---

## 📱 모바일 특수 플로우

### 하단 네비게이션
```
모바일 → 하단 고정 Nav
  ↓
탭 전환 시 → 페이지 유지
  ↓
같은 탭 재클릭 → 최상단 스크롤
```

### 카카오 앱 로그인
```
모바일 브라우저 → 로그인 클릭
  ↓
카카오톡 앱 실행
  ↓
인증 완료 → 브라우저 복귀
  ↓
원래 페이지로 리다이렉트
```

---

## 🎯 구현 체크포인트

### Phase 1 (긴급)
- [ ] 모든 인증 필요 페이지에 401 체크
- [ ] 401 → 로그인 리다이렉트
- [ ] 로그인 후 원래 페이지 복귀

### Phase 2 (중요)
- [ ] API Key 설정 플로우
- [ ] 세션 만료 처리
- [ ] 에러별 Toast 메시지

### Phase 3 (개선)
- [ ] 로딩 상태 통일
- [ ] 에러 재시도 로직
- [ ] 모바일 최적화

---

*이 문서는 모든 페이지 작업 시 필수 참조*