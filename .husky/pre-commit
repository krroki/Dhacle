#!/bin/sh
# Pre-commit Hook v3.0 - Wave 4 재발 방지 체계
# 2025-02-21: 타입 시스템 재발 방지 강화

echo "🔍 Pre-commit 검증 시작..."

# 1단계: Any 타입 차단 (최우선 검사) - .md 파일 제외
echo "📋 Step 1/5: Any 타입 차단..."
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | grep -v '\.md$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  # staged 파일에서 any 타입 검색
  for file in $STAGED_TS_FILES; do
    if grep -q ": any" "$file" 2>/dev/null; then
      if ! grep -q "eslint-disable" "$file" 2>/dev/null; then
        echo "❌ any 타입 사용 금지!"
        echo "  파일: $file"
        echo ""
        echo "💡 해결 방법:"
        echo "  1. 구체적 타입으로 교체"
        echo "  2. unknown 사용 후 타입 가드"
        echo "  3. 제안 도구 사용: node scripts/type-suggester.js $file"
        exit 1
      fi
    fi
  done
fi

# 2단계: 타입 시스템 검증
echo "📋 Step 2/7: 타입 시스템 검증..."
node scripts/type-validator.js || {
  echo "❌ 타입 시스템 검증 실패!"
  echo ""
  echo "💡 자세한 정보는 위 메시지 참조"
  exit 1
}

# 3단계: 임시 처리 감지 (STOP & ACT 원칙)
echo "📋 Step 3/7: 임시 처리 패턴 감지..."
if [ -f "scripts/detect-temporary-fixes.js" ]; then
  node scripts/detect-temporary-fixes.js || {
    echo "❌ 임시 처리 패턴 발견!"
    echo ""
    echo "🛑 STOP & ACT 원칙에 따라 커밋이 차단되었습니다."
    echo ""
    echo "💡 필수 조치:"
    echo "  - 주석 처리된 DB 호출 → 테이블 생성 SQL 작성"
    echo "  - TODO 주석 → 즉시 구현"
    echo "  - 빈 배열/null 반환 → 실제 로직 구현"
    echo "  - any 타입 → 구체적 타입 정의"
    echo ""
    echo "📖 자세한 내용: CLAUDE.md의 'STOP & ACT' 섹션 참조"
    exit 1
  }
else
  echo "  ⚠️ 감지 스크립트 없음 - 건너뜀"
fi

# 4단계: 빠른 핵심 검증
echo "📋 Step 4/7: 핵심 검증 실행 중..."
npm run verify:quick || {
  echo "❌ 핵심 검증 실패! 다음 문제를 수정하세요:"
  echo "  - API 인증 일치성 문제"
  echo "  - TypeScript 타입 안정성 문제"
  echo ""
  echo "💡 문제 확인 방법:"
  echo "  - API 검증: npm run verify:api"
  echo "  - 타입 검증: npm run verify:types"
  exit 1
}

# 5단계: TypeScript 컴파일 체크 (staged 파일만)
echo "📋 Step 5/7: TypeScript 컴파일 검증..."

if [ -n "$STAGED_TS_FILES" ]; then
  echo "  검증 대상: $(echo $STAGED_TS_FILES | wc -w)개 파일"
  
  npx tsc --noEmit --skipLibCheck || {
    echo "❌ TypeScript 컴파일 오류!"
    echo ""
    echo "💡 해결 방법:"
    echo "  1. 타입 오류 확인: npm run types:check"
    echo "  2. DB 변경 시: npm run types:generate"
    echo "  3. 수동으로 타입 오류 수정"
    echo ""
    echo "⚠️ 자동 수정 도구는 제거되었습니다. 수동 수정이 필요합니다."
    exit 1
  }
fi

# 6단계: API Route 보안 검증 (staged API 파일만)
echo "📋 Step 6/7: API Route 보안 검증..."
STAGED_API_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/app/api/.*route\.(ts|tsx)$' || true)

if [ -n "$STAGED_API_FILES" ]; then
  echo "  API Route 변경 감지 - 보안 검증 실행"
  npm run verify:routes || {
    echo "❌ API Route 보안 검증 실패!"
    echo "  모든 API Route는 인증 체크가 필요합니다."
    echo ""
    echo "💡 올바른 패턴:"
    echo "  const { data: { user } } = await supabase.auth.getUser();"
    echo "  if (!user) {"
    echo "    return NextResponse.json("
    echo "      { error: 'User not authenticated' },"
    echo "      { status: 401 }"
    echo "    );"
    echo "  }"
    exit 1
  }
fi

# 7단계: YouTube API 패턴 검증 (YouTube 관련 파일만)
echo "📋 Step 7/7: YouTube API 패턴 검증..."
STAGED_YOUTUBE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(youtube|YouTube).*\.(ts|tsx)$' || true)

if [ -n "$STAGED_YOUTUBE_FILES" ]; then
  echo "  YouTube 관련 파일 변경 감지 - API 패턴 검증 실행"
  node scripts/verify-youtube-api.js || {
    echo "❌ YouTube API 패턴 검증 실패!"
    echo ""
    echo "💡 확인된 문제:"
    echo "  - YouTube API 응답 필드는 camelCase 사용 (channelId, viewCount 등)"
    echo "  - DB 저장 시에만 snake_case로 변환"
    echo "  - API Key는 env.ts에서 import"
    echo "  - process.env 직접 접근 금지"
    echo ""
    echo "📖 자세한 내용은 위 메시지 참조"
    exit 1
  }
fi

# 8단계: 코드 중복 검사 (jscpd)
echo "📋 Step 8/9: 코드 중복 검사..."
if [ -f ".jscpd.json" ]; then
  STAGED_CODE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|sql)$' | grep -v '\.md$' || true)
  
  if [ -n "$STAGED_CODE_FILES" ]; then
    echo "  중복 코드 검사 중... ($(echo $STAGED_CODE_FILES | wc -w)개 파일)"
    npm run jscpd:silent || {
      echo "⚠️ 코드 중복 발견!"
      echo ""
      echo "💡 해결 방법:"
      echo "  1. 상세 리포트: npm run jscpd:verbose"
      echo "  2. 중복 제거 후 다시 커밋"
      echo "  3. 공통 함수/컴포넌트로 추출"
      echo ""
      echo "📈 중복률이 5% 이상이면 커밋이 차단됩니다."
      exit 1
    }
  fi
else
  echo "  ⚠️ jscpd 설정 없음 - 건너뜀"
fi

# 9단계: 자산 인벤토리 업데이트
echo "📋 Step 9/9: 자산 인벤토리 업데이트..."
if [ -f "scripts/asset-scanner.js" ]; then
  # 파일 변경 시에만 자산 스캔 실행
  STAGED_ASSET_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(src/components/|src/app/api/|supabase/migrations/).*\.(ts|tsx|js|jsx|sql)$' || true)
  
  if [ -n "$STAGED_ASSET_FILES" ]; then
    echo "  자산 변경 감지 - 인벤토리 업데이트 중..."
    npm run scan:assets > /dev/null || {
      echo "⚠️ 자산 스캔 실패"
      echo "  계속 진행하지만 인벤토리가 최신 상태가 아닐 수 있습니다."
    }
    
    # 업데이트된 인벤토리를 자동으로 스테이징
    if [ -f "asset-inventory.json" ]; then
      git add asset-inventory.json
      echo "  ✅ 자산 인벤토리 업데이트 완료"
    fi
  else
    echo "  자산 변경 없음 - 건너뜀"
  fi
else
  echo "  ⚠️ 자산 스캐너 없음 - 건너뜀"
fi

# 추가: Biome 코드 품질 검사 (선택적) - .md 파일 제외
echo "📋 추가: 코드 품질 검사..."
if [ -f "biome.json" ]; then
  STAGED_SRC_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/.*\.(ts|tsx|js|jsx)$' | grep -v '\.md$' || true)
  
  if [ -n "$STAGED_SRC_FILES" ]; then
    echo "  Biome 검사 중... ($(echo $STAGED_SRC_FILES | wc -w)개 파일)"
    npx biome check $STAGED_SRC_FILES || {
      echo "⚠️ 코드 품질 이슈 발견!"
      echo ""
      echo "💡 수동 수정 방법:"
      echo "  1. 문제 확인: npm run lint:biome"
      echo "  2. 수동으로 코드 수정"
      echo "  3. 다시 git add 후 커밋"
      echo ""
      echo "⚠️ 자동 수정(--write, --fix)은 비활성화되었습니다."
      exit 1
    }
  fi
else
  echo "  ⚠️ Biome 설정 없음 - 건너뜀"
fi

echo "✅ Pre-commit 검증 통과!"
echo ""
echo "📌 참고사항:"
echo "  - 모든 자동 수정 기능이 제거되었습니다"
echo "  - 문제 발견 시 수동 수정이 필요합니다"
echo "  - 검증 건너뛰기: git commit --no-verify -m \"message\""
echo ""

exit 0