# Pre-commit Hook v1.0
# ì»¤ë°‹ ì „ ì½”ë“œ í’ˆì§ˆ ê²€ì¦

echo "ğŸ” Pre-commit ê²€ì¦ ì‹œì‘..."

# 1ë‹¨ê³„: ë¹ ë¥¸ í•µì‹¬ ê²€ì¦ (5ì´ˆ ì´ë‚´)
echo "ğŸ“‹ Step 1/3: í•µì‹¬ ê²€ì¦ ì‹¤í–‰ ì¤‘..."
npm run verify:quick || {
  echo "âŒ í•µì‹¬ ê²€ì¦ ì‹¤íŒ¨! ë‹¤ìŒ ë¬¸ì œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”:"
  echo "  - API ì¸ì¦ ì¼ì¹˜ì„±"
  echo "  - TypeScript íƒ€ì… ì•ˆì •ì„±"
  exit 1
}

# 2ë‹¨ê³„: staged íŒŒì¼ë§Œ ê²€ì¦ (ì„±ëŠ¥ ìµœì í™”)
echo "ğŸ“‹ Step 2/3: Staged íŒŒì¼ ê²€ì¦ ì¤‘..."

# stagedëœ TypeScript íŒŒì¼ ëª©ë¡
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  echo "  ê²€ì¦ ëŒ€ìƒ: $(echo $STAGED_TS_FILES | wc -w)ê°œ íŒŒì¼"
  
  # TypeScript ì»´íŒŒì¼ ì²´í¬
  npx tsc --noEmit --skipLibCheck || {
    echo "âŒ TypeScript ì»´íŒŒì¼ ì˜¤ë¥˜!"
    echo ""
    echo "ğŸ’¡ í•´ê²° ë°©ë²•:"
    echo "  1. ìë™ ìˆ˜ì • ì‹œë„: npm run types:auto-fix"
    echo "  2. DB ë³€ê²½ ì‹œ: npm run types:generate"
    echo "  3. íƒ€ì… í™•ì¸: npm run types:check"
    exit 1
  }
fi

# stagedëœ API route íŒŒì¼ í™•ì¸
STAGED_API_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/app/api/.*route\.(ts|tsx)$' || true)

if [ -n "$STAGED_API_FILES" ]; then
  echo "  API Route ë³€ê²½ ê°ì§€ - ë³´ì•ˆ ê²€ì¦ ì‹¤í–‰"
  npm run verify:routes || {
    echo "âŒ API Route ë³´ì•ˆ ê²€ì¦ ì‹¤íŒ¨!"
    echo "  ëª¨ë“  API RouteëŠ” ì¸ì¦ ì²´í¬ê°€ í•„ìš”í•©ë‹ˆë‹¤."
    exit 1
  }
fi

# 3ë‹¨ê³„: Biome ë¦°íŒ… ë° í¬ë§·íŒ… (ìƒˆë¡œ ì¶”ê°€!)
echo "ğŸ“‹ Step 3/5: Biome ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬..."

# Biome ì„¤ì¹˜ í™•ì¸ ë° ì‹¤í–‰
if [ -f "biome.json" ]; then
  # stagedëœ ì†ŒìŠ¤ íŒŒì¼ë§Œ ê²€ì‚¬
  STAGED_SRC_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/.*\.(ts|tsx|js|jsx)$' || true)
  
  if [ -n "$STAGED_SRC_FILES" ]; then
    echo "  Biome ê²€ì‚¬ ì¤‘... ($(echo $STAGED_SRC_FILES | wc -w)ê°œ íŒŒì¼)"
    npx biome check --write $STAGED_SRC_FILES || {
      echo "âš ï¸  Biome ê²€ì‚¬ ê²½ê³  - ìë™ ìˆ˜ì • ì‹œë„ë¨"
      echo "  'npm run lint:biome:fix'ë¡œ ì „ì²´ ìˆ˜ì • ê°€ëŠ¥"
    }
    # ìˆ˜ì •ëœ íŒŒì¼ ë‹¤ì‹œ stage
    echo "$STAGED_SRC_FILES" | xargs git add
  fi
else
  echo "  âš ï¸  Biome ì„¤ì • ì—†ìŒ - ê±´ë„ˆëœ€"
fi

# 4ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Vitest)
echo "ğŸ“‹ Step 4/5: í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."

# stagedëœ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ íŒŒì¼ í™•ì¸
STAGED_TESTABLE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/.*\.(ts|tsx)$' | grep -v '\.test\.' | grep -v '\.spec\.' || true)

if [ -n "$STAGED_TESTABLE_FILES" ]; then
  # í•´ë‹¹ íŒŒì¼ì˜ í…ŒìŠ¤íŠ¸ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
  HAS_TEST_FILES=false
  for FILE in $STAGED_TESTABLE_FILES; do
    TEST_FILE="${FILE%.*}.test.${FILE##*.}"
    SPEC_FILE="${FILE%.*}.spec.${FILE##*.}"
    if [ -f "$TEST_FILE" ] || [ -f "$SPEC_FILE" ]; then
      HAS_TEST_FILES=true
      break
    fi
  done
  
  if [ "$HAS_TEST_FILES" = true ]; then
    echo "  í…ŒìŠ¤íŠ¸ íŒŒì¼ ê°ì§€ - ê´€ë ¨ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
    npm run verify:test || {
      echo "âš ï¸  í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ - í…ŒìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”"
      echo "  'npm run test'ë¡œ ìƒì„¸ í™•ì¸ ê°€ëŠ¥"
      # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ëŠ” ê²½ê³ ë§Œ, ì»¤ë°‹ì€ í—ˆìš©
    }
  else
    echo "  âš ï¸  í…ŒìŠ¤íŠ¸ íŒŒì¼ ì—†ìŒ - í…ŒìŠ¤íŠ¸ ì‘ì„±ì„ ê¶Œì¥í•©ë‹ˆë‹¤"
  fi
else
  echo "  í…ŒìŠ¤íŠ¸ ëŒ€ìƒ íŒŒì¼ ì—†ìŒ - ê±´ë„ˆëœ€"
fi

# 5ë‹¨ê³„: ìë™ í¬ë§·íŒ… (ì„ íƒì )
echo "ğŸ“‹ Step 5/5: ì½”ë“œ í¬ë§·íŒ…..."

# Prettier ì„¤ì¹˜ í™•ì¸
if command -v npx prettier > /dev/null 2>&1; then
  # staged íŒŒì¼ë§Œ í¬ë§·íŒ…
  STAGED_FORMAT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|md)$' || true)
  
  if [ -n "$STAGED_FORMAT_FILES" ]; then
    echo "$STAGED_FORMAT_FILES" | xargs npx prettier --write
    echo "$STAGED_FORMAT_FILES" | xargs git add
    echo "  âœ… ì½”ë“œ í¬ë§·íŒ… ì™„ë£Œ"
  fi
else
  echo "  âš ï¸  Prettier ì—†ìŒ - í¬ë§·íŒ… ê±´ë„ˆëœ€"
fi

echo "âœ… Pre-commit ê²€ì¦ í†µê³¼!"
echo ""
echo "ğŸ’¡ íŒ: ê²€ì¦ ì—†ì´ ì»¤ë°‹í•˜ë ¤ë©´ --no-verify ì‚¬ìš©"
echo "  git commit --no-verify -m \"message\""
echo ""

exit 0