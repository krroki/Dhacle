# Pre-commit Hook v1.0
# 커밋 전 코드 품질 검증

echo "🔍 Pre-commit 검증 시작..."

# 1단계: 빠른 핵심 검증 (5초 이내)
echo "📋 Step 1/3: 핵심 검증 실행 중..."
npm run verify:quick || {
  echo "❌ 핵심 검증 실패! 다음 문제를 수정하세요:"
  echo "  - API 인증 일치성"
  echo "  - TypeScript 타입 안정성"
  exit 1
}

# 2단계: staged 파일만 검증 (성능 최적화)
echo "📋 Step 2/3: Staged 파일 검증 중..."

# staged된 TypeScript 파일 목록
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  echo "  검증 대상: $(echo $STAGED_TS_FILES | wc -w)개 파일"
  
  # TypeScript 컴파일 체크
  npx tsc --noEmit --skipLibCheck || {
    echo "❌ TypeScript 컴파일 오류!"
    echo ""
    echo "💡 해결 방법:"
    echo "  1. 자동 수정 시도: npm run types:auto-fix"
    echo "  2. DB 변경 시: npm run types:generate"
    echo "  3. 타입 확인: npm run types:check"
    exit 1
  }
fi

# staged된 API route 파일 확인
STAGED_API_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/app/api/.*route\.(ts|tsx)$' || true)

if [ -n "$STAGED_API_FILES" ]; then
  echo "  API Route 변경 감지 - 보안 검증 실행"
  npm run verify:routes || {
    echo "❌ API Route 보안 검증 실패!"
    echo "  모든 API Route는 인증 체크가 필요합니다."
    exit 1
  }
fi

# 3단계: snake_case 금지 패턴 검사
echo "📋 Step 3/6: React/라이브러리 필드 보호 검사..."

# displayName 오염 검사
if grep -r "\.display_name\b" src --include="*.tsx" --include="*.ts" --quiet 2>/dev/null; then
  echo "❌ 오류: display_name 사용이 감지되었습니다!"
  echo "  React 컴포넌트는 displayName을 사용해야 합니다."
  echo "  발견 위치:"
  grep -r "\.display_name\b" src --include="*.tsx" --include="*.ts" -n | head -5
  exit 1
fi

# JSX 속성 오염 검사
if grep -r "class_name\|html_for\|on_click\|on_change\|default_value" src --include="*.tsx" --quiet 2>/dev/null; then
  echo "❌ 오류: snake_case JSX 속성이 감지되었습니다!"
  echo "  JSX는 camelCase 속성을 사용해야 합니다."
  echo "  발견 위치:"
  grep -r "class_name\|html_for\|on_click" src --include="*.tsx" -n | head -5
  exit 1
fi

echo "  ✅ React/라이브러리 필드 정상"

# 4단계: Biome 린팅 및 포맷팅 (새로 추가!)
echo "📋 Step 4/6: Biome 코드 품질 검사..."

# Biome 설치 확인 및 실행
if [ -f "biome.json" ]; then
  # staged된 소스 파일만 검사
  STAGED_SRC_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/.*\.(ts|tsx|js|jsx)$' || true)
  
  if [ -n "$STAGED_SRC_FILES" ]; then
    echo "  Biome 검사 중... ($(echo $STAGED_SRC_FILES | wc -w)개 파일)"
    npx biome check $STAGED_SRC_FILES || {
      echo "⚠️  Biome 검사 실패 - 수정이 필요합니다"
      echo "  'npm run lint:biome:fix'로 자동 수정 가능"
      echo "  수정 후 다시 커밋하세요"
      exit 1
    }
  fi
else
  echo "  ⚠️  Biome 설정 없음 - 건너뜀"
fi

# 5단계: 테스트 실행 (Vitest)
echo "📋 Step 5/6: 테스트 실행..."

# staged된 테스트 가능한 파일 확인
STAGED_TESTABLE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/.*\.(ts|tsx)$' | grep -v '\.test\.' | grep -v '\.spec\.' || true)

if [ -n "$STAGED_TESTABLE_FILES" ]; then
  # 해당 파일의 테스트 파일 존재 여부 확인
  HAS_TEST_FILES=false
  for FILE in $STAGED_TESTABLE_FILES; do
    TEST_FILE="${FILE%.*}.test.${FILE##*.}"
    SPEC_FILE="${FILE%.*}.spec.${FILE##*.}"
    if [ -f "$TEST_FILE" ] || [ -f "$SPEC_FILE" ]; then
      HAS_TEST_FILES=true
      break
    fi
  done
  
  if [ "$HAS_TEST_FILES" = true ]; then
    echo "  테스트 파일 감지 - 관련 테스트 실행 중..."
    npm run verify:test || {
      echo "⚠️  테스트 실패 - 테스트를 확인하세요"
      echo "  'npm run test'로 상세 확인 가능"
      # 테스트 실패는 경고만, 커밋은 허용
    }
  else
    echo "  ⚠️  테스트 파일 없음 - 테스트 작성을 권장합니다"
  fi
else
  echo "  테스트 대상 파일 없음 - 건너뜀"
fi

# 6단계: 포맷팅 검사 (수정 없이 검사만)
echo "📋 Step 6/6: 코드 포맷팅 검사..."

# Prettier 설치 확인
if command -v npx prettier > /dev/null 2>&1; then
  # staged 파일 포맷팅 검사
  STAGED_FORMAT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|md)$' || true)
  
  if [ -n "$STAGED_FORMAT_FILES" ]; then
    echo "$STAGED_FORMAT_FILES" | xargs npx prettier --check || {
      echo "  ⚠️  포맷팅 필요 - 'npm run format'으로 수정 가능"
      # 포맷팅은 경고만, 커밋은 허용
    }
  fi
else
  echo "  ⚠️  Prettier 없음 - 포맷팅 검사 건너뜀"
fi

echo "✅ Pre-commit 검증 통과!"
echo ""
echo "💡 팁: 검증 없이 커밋하려면 --no-verify 사용"
echo "  git commit --no-verify -m \"message\""
echo ""

exit 0