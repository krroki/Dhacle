#!/bin/sh
# Pre-commit Hook v2.0 - ê²€ì¦ ì „ìš© (ìë™ ìˆ˜ì • ì—†ìŒ)
# 2025-01-31: ëª¨ë“  ìë™ ìˆ˜ì • ê¸°ëŠ¥ ì œê±°, ê²€ì¦ë§Œ ìˆ˜í–‰

echo "ğŸ” Pre-commit ê²€ì¦ ì‹œì‘..."

# 1ë‹¨ê³„: ë¹ ë¥¸ í•µì‹¬ ê²€ì¦
echo "ğŸ“‹ Step 1/4: í•µì‹¬ ê²€ì¦ ì‹¤í–‰ ì¤‘..."
npm run verify:quick || {
  echo "âŒ í•µì‹¬ ê²€ì¦ ì‹¤íŒ¨! ë‹¤ìŒ ë¬¸ì œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”:"
  echo "  - API ì¸ì¦ ì¼ì¹˜ì„± ë¬¸ì œ"
  echo "  - TypeScript íƒ€ì… ì•ˆì •ì„± ë¬¸ì œ"
  echo ""
  echo "ğŸ’¡ ë¬¸ì œ í™•ì¸ ë°©ë²•:"
  echo "  - API ê²€ì¦: npm run verify:api"
  echo "  - íƒ€ì… ê²€ì¦: npm run verify:types"
  exit 1
}

# 2ë‹¨ê³„: TypeScript ì»´íŒŒì¼ ì²´í¬ (staged íŒŒì¼ë§Œ)
echo "ğŸ“‹ Step 2/4: TypeScript ì»´íŒŒì¼ ê²€ì¦..."
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  echo "  ê²€ì¦ ëŒ€ìƒ: $(echo $STAGED_TS_FILES | wc -w)ê°œ íŒŒì¼"
  
  npx tsc --noEmit --skipLibCheck || {
    echo "âŒ TypeScript ì»´íŒŒì¼ ì˜¤ë¥˜!"
    echo ""
    echo "ğŸ’¡ í•´ê²° ë°©ë²•:"
    echo "  1. íƒ€ì… ì˜¤ë¥˜ í™•ì¸: npm run types:check"
    echo "  2. DB ë³€ê²½ ì‹œ: npm run types:generate"
    echo "  3. ìˆ˜ë™ìœ¼ë¡œ íƒ€ì… ì˜¤ë¥˜ ìˆ˜ì •"
    echo ""
    echo "âš ï¸ ìë™ ìˆ˜ì • ë„êµ¬ëŠ” ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤."
    exit 1
  }
fi

# 3ë‹¨ê³„: API Route ë³´ì•ˆ ê²€ì¦ (staged API íŒŒì¼ë§Œ)
echo "ğŸ“‹ Step 3/4: API Route ë³´ì•ˆ ê²€ì¦..."
STAGED_API_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/app/api/.*route\.(ts|tsx)$' || true)

if [ -n "$STAGED_API_FILES" ]; then
  echo "  API Route ë³€ê²½ ê°ì§€ - ë³´ì•ˆ ê²€ì¦ ì‹¤í–‰"
  npm run verify:routes || {
    echo "âŒ API Route ë³´ì•ˆ ê²€ì¦ ì‹¤íŒ¨!"
    echo "  ëª¨ë“  API RouteëŠ” ì¸ì¦ ì²´í¬ê°€ í•„ìš”í•©ë‹ˆë‹¤."
    echo ""
    echo "ğŸ’¡ ì˜¬ë°”ë¥¸ íŒ¨í„´:"
    echo "  const { data: { user } } = await supabase.auth.getUser();"
    echo "  if (!user) {"
    echo "    return NextResponse.json("
    echo "      { error: 'User not authenticated' },"
    echo "      { status: 401 }"
    echo "    );"
    echo "  }"
    exit 1
  }
fi

# 4ë‹¨ê³„: Biome ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ê²€ì‚¬ë§Œ, ìˆ˜ì • ì—†ìŒ)
echo "ğŸ“‹ Step 4/4: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬..."
if [ -f "biome.json" ]; then
  STAGED_SRC_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/.*\.(ts|tsx|js|jsx)$' || true)
  
  if [ -n "$STAGED_SRC_FILES" ]; then
    echo "  Biome ê²€ì‚¬ ì¤‘... ($(echo $STAGED_SRC_FILES | wc -w)ê°œ íŒŒì¼)"
    npx biome check $STAGED_SRC_FILES || {
      echo "âš ï¸ ì½”ë“œ í’ˆì§ˆ ì´ìŠˆ ë°œê²¬!"
      echo ""
      echo "ğŸ’¡ ìˆ˜ë™ ìˆ˜ì • ë°©ë²•:"
      echo "  1. ë¬¸ì œ í™•ì¸: npm run lint:biome"
      echo "  2. ìˆ˜ë™ìœ¼ë¡œ ì½”ë“œ ìˆ˜ì •"
      echo "  3. ë‹¤ì‹œ git add í›„ ì»¤ë°‹"
      echo ""
      echo "âš ï¸ ìë™ ìˆ˜ì •(--write, --fix)ì€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
      exit 1
    }
  fi
else
  echo "  âš ï¸ Biome ì„¤ì • ì—†ìŒ - ê±´ë„ˆëœ€"
fi

echo "âœ… Pre-commit ê²€ì¦ í†µê³¼!"
echo ""
echo "ğŸ“Œ ì°¸ê³ ì‚¬í•­:"
echo "  - ëª¨ë“  ìë™ ìˆ˜ì • ê¸°ëŠ¥ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤"
echo "  - ë¬¸ì œ ë°œê²¬ ì‹œ ìˆ˜ë™ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤"
echo "  - ê²€ì¦ ê±´ë„ˆë›°ê¸°: git commit --no-verify -m \"message\""
echo ""

exit 0