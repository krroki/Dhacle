#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Pre-commit Hook v1.0
# ì»¤ë°‹ ì „ ì½”ë“œ í’ˆì§ˆ ê²€ì¦

echo "ğŸ” Pre-commit ê²€ì¦ ì‹œì‘..."

# 1ë‹¨ê³„: ë¹ ë¥¸ í•µì‹¬ ê²€ì¦ (5ì´ˆ ì´ë‚´)
echo "ğŸ“‹ Step 1/3: í•µì‹¬ ê²€ì¦ ì‹¤í–‰ ì¤‘..."
npm run verify:quick || {
  echo "âŒ í•µì‹¬ ê²€ì¦ ì‹¤íŒ¨! ë‹¤ìŒ ë¬¸ì œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”:"
  echo "  - API ì¸ì¦ ì¼ì¹˜ì„±"
  echo "  - TypeScript íƒ€ì… ì•ˆì •ì„±"
  exit 1
}

# 2ë‹¨ê³„: staged íŒŒì¼ë§Œ ê²€ì¦ (ì„±ëŠ¥ ìµœì í™”)
echo "ğŸ“‹ Step 2/3: Staged íŒŒì¼ ê²€ì¦ ì¤‘..."

# stagedëœ TypeScript íŒŒì¼ ëª©ë¡
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  echo "  ê²€ì¦ ëŒ€ìƒ: $(echo $STAGED_TS_FILES | wc -w)ê°œ íŒŒì¼"
  
  # TypeScript ì»´íŒŒì¼ ì²´í¬
  npx tsc --noEmit --skipLibCheck || {
    echo "âŒ TypeScript ì»´íŒŒì¼ ì˜¤ë¥˜!"
    exit 1
  }
fi

# stagedëœ API route íŒŒì¼ í™•ì¸
STAGED_API_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/app/api/.*route\.(ts|tsx)$' || true)

if [ -n "$STAGED_API_FILES" ]; then
  echo "  API Route ë³€ê²½ ê°ì§€ - ë³´ì•ˆ ê²€ì¦ ì‹¤í–‰"
  npm run verify:routes || {
    echo "âŒ API Route ë³´ì•ˆ ê²€ì¦ ì‹¤íŒ¨!"
    echo "  ëª¨ë“  API RouteëŠ” ì¸ì¦ ì²´í¬ê°€ í•„ìš”í•©ë‹ˆë‹¤."
    exit 1
  }
fi

# 3ë‹¨ê³„: ìë™ í¬ë§·íŒ… (ì„ íƒì )
echo "ğŸ“‹ Step 3/3: ì½”ë“œ í¬ë§·íŒ…..."

# Prettier ì„¤ì¹˜ í™•ì¸
if command -v npx prettier > /dev/null 2>&1; then
  # staged íŒŒì¼ë§Œ í¬ë§·íŒ…
  STAGED_FORMAT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|md)$' || true)
  
  if [ -n "$STAGED_FORMAT_FILES" ]; then
    echo "$STAGED_FORMAT_FILES" | xargs npx prettier --write
    echo "$STAGED_FORMAT_FILES" | xargs git add
    echo "  âœ… ì½”ë“œ í¬ë§·íŒ… ì™„ë£Œ"
  fi
else
  echo "  âš ï¸  Prettier ì—†ìŒ - í¬ë§·íŒ… ê±´ë„ˆëœ€"
fi

echo "âœ… Pre-commit ê²€ì¦ í†µê³¼!"
echo ""
echo "ğŸ’¡ íŒ: ê²€ì¦ ì—†ì´ ì»¤ë°‹í•˜ë ¤ë©´ --no-verify ì‚¬ìš©"
echo "  git commit --no-verify -m \"message\""
echo ""

exit 0