#!/bin/sh
# Pre-commit Hook v3.0 - Wave 4 ì¬ë°œ ë°©ì§€ ì²´ê³„
# 2025-02-21: íƒ€ì… ì‹œìŠ¤í…œ ì¬ë°œ ë°©ì§€ ê°•í™”

echo "ğŸ” Pre-commit ê²€ì¦ ì‹œì‘..."

# 1ë‹¨ê³„: Any íƒ€ì… ì°¨ë‹¨ (ìµœìš°ì„  ê²€ì‚¬)
echo "ğŸ“‹ Step 1/5: Any íƒ€ì… ì°¨ë‹¨..."
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  # staged íŒŒì¼ì—ì„œ any íƒ€ì… ê²€ìƒ‰
  for file in $STAGED_TS_FILES; do
    if grep -q ": any" "$file" 2>/dev/null; then
      # ì˜ë„ì ì¸ as any ì‚¬ìš© íŒŒì¼ ì²´í¬ (íƒ€ì… ì‹œìŠ¤í…œ ë³µêµ¬ ê³¼ì •ì—ì„œ ì¼ì‹œì ìœ¼ë¡œ í—ˆìš©)
      # ì´ íŒŒì¼ë“¤ì€ DB ìŠ¤í‚¤ë§ˆì™€ ë¶ˆì¼ì¹˜í•˜ëŠ” í•„ë“œê°€ ìˆì–´ ì„ì‹œë¡œ as any ì‚¬ìš©
      if echo "$file" | grep -E "(popular-shorts\.ts|collections-server\.ts|metrics\.ts|queue-manager\.ts|typed-client\.ts|predictor\.ts|type-mappers\.ts)" > /dev/null; then
        echo "âš ï¸ ê²½ê³ : ì˜ë„ì ì¸ 'as any' ì‚¬ìš© ê°ì§€ (íƒ€ì… ì‹œìŠ¤í…œ ë³µêµ¬ ì¤‘)"
        echo "  íŒŒì¼: $file"
        echo "  ì´ìœ : DB ìŠ¤í‚¤ë§ˆì™€ ì„ì‹œ ë¶ˆì¼ì¹˜ (video_stats í…Œì´ë¸” ì¶”ê°€ í•„ë“œ ëŒ€ê¸° ì¤‘)"
        echo "  TODO: DB ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ì œê±° í•„ìš”"
        echo ""
      elif ! grep -q "eslint-disable" "$file" 2>/dev/null; then
        echo "âŒ any íƒ€ì… ì‚¬ìš© ê¸ˆì§€!"
        echo "  íŒŒì¼: $file"
        echo ""
        echo "ğŸ’¡ í•´ê²° ë°©ë²•:"
        echo "  1. êµ¬ì²´ì  íƒ€ì…ìœ¼ë¡œ êµì²´"
        echo "  2. unknown ì‚¬ìš© í›„ íƒ€ì… ê°€ë“œ"
        echo "  3. ì œì•ˆ ë„êµ¬ ì‚¬ìš©: node scripts/type-suggester.js $file"
        exit 1
      fi
    fi
  done
fi

# 2ë‹¨ê³„: íƒ€ì… ì‹œìŠ¤í…œ ê²€ì¦
echo "ğŸ“‹ Step 2/5: íƒ€ì… ì‹œìŠ¤í…œ ê²€ì¦..."
node scripts/type-validator.js || {
  echo "âŒ íƒ€ì… ì‹œìŠ¤í…œ ê²€ì¦ ì‹¤íŒ¨!"
  echo ""
  echo "ğŸ’¡ ìì„¸í•œ ì •ë³´ëŠ” ìœ„ ë©”ì‹œì§€ ì°¸ì¡°"
  exit 1
}

# 3ë‹¨ê³„: ë¹ ë¥¸ í•µì‹¬ ê²€ì¦
echo "ğŸ“‹ Step 3/5: í•µì‹¬ ê²€ì¦ ì‹¤í–‰ ì¤‘..."
npm run verify:quick || {
  echo "âŒ í•µì‹¬ ê²€ì¦ ì‹¤íŒ¨! ë‹¤ìŒ ë¬¸ì œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”:"
  echo "  - API ì¸ì¦ ì¼ì¹˜ì„± ë¬¸ì œ"
  echo "  - TypeScript íƒ€ì… ì•ˆì •ì„± ë¬¸ì œ"
  echo ""
  echo "ğŸ’¡ ë¬¸ì œ í™•ì¸ ë°©ë²•:"
  echo "  - API ê²€ì¦: npm run verify:api"
  echo "  - íƒ€ì… ê²€ì¦: npm run verify:types"
  exit 1
}

# 4ë‹¨ê³„: TypeScript ì»´íŒŒì¼ ì²´í¬ (staged íŒŒì¼ë§Œ)
echo "ğŸ“‹ Step 4/5: TypeScript ì»´íŒŒì¼ ê²€ì¦..."

if [ -n "$STAGED_TS_FILES" ]; then
  echo "  ê²€ì¦ ëŒ€ìƒ: $(echo $STAGED_TS_FILES | wc -w)ê°œ íŒŒì¼"
  
  npx tsc --noEmit --skipLibCheck || {
    echo "âŒ TypeScript ì»´íŒŒì¼ ì˜¤ë¥˜!"
    echo ""
    echo "ğŸ’¡ í•´ê²° ë°©ë²•:"
    echo "  1. íƒ€ì… ì˜¤ë¥˜ í™•ì¸: npm run types:check"
    echo "  2. DB ë³€ê²½ ì‹œ: npm run types:generate"
    echo "  3. ìˆ˜ë™ìœ¼ë¡œ íƒ€ì… ì˜¤ë¥˜ ìˆ˜ì •"
    echo ""
    echo "âš ï¸ ìë™ ìˆ˜ì • ë„êµ¬ëŠ” ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤."
    exit 1
  }
fi

# 5ë‹¨ê³„: API Route ë³´ì•ˆ ê²€ì¦ (staged API íŒŒì¼ë§Œ)
echo "ğŸ“‹ Step 5/5: API Route ë³´ì•ˆ ê²€ì¦..."
STAGED_API_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/app/api/.*route\.(ts|tsx)$' || true)

if [ -n "$STAGED_API_FILES" ]; then
  echo "  API Route ë³€ê²½ ê°ì§€ - ë³´ì•ˆ ê²€ì¦ ì‹¤í–‰"
  npm run verify:routes || {
    echo "âŒ API Route ë³´ì•ˆ ê²€ì¦ ì‹¤íŒ¨!"
    echo "  ëª¨ë“  API RouteëŠ” ì¸ì¦ ì²´í¬ê°€ í•„ìš”í•©ë‹ˆë‹¤."
    echo ""
    echo "ğŸ’¡ ì˜¬ë°”ë¥¸ íŒ¨í„´:"
    echo "  const { data: { user } } = await supabase.auth.getUser();"
    echo "  if (!user) {"
    echo "    return NextResponse.json("
    echo "      { error: 'User not authenticated' },"
    echo "      { status: 401 }"
    echo "    );"
    echo "  }"
    exit 1
  }
fi

# ì¶”ê°€: Biome ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ì„ íƒì )
echo "ğŸ“‹ ì¶”ê°€: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬..."
if [ -f "biome.json" ]; then
  STAGED_SRC_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/.*\.(ts|tsx|js|jsx)$' || true)
  
  if [ -n "$STAGED_SRC_FILES" ]; then
    echo "  Biome ê²€ì‚¬ ì¤‘... ($(echo $STAGED_SRC_FILES | wc -w)ê°œ íŒŒì¼)"
    npx biome check $STAGED_SRC_FILES || {
      echo "âš ï¸ ì½”ë“œ í’ˆì§ˆ ì´ìŠˆ ë°œê²¬!"
      echo ""
      echo "ğŸ’¡ ìˆ˜ë™ ìˆ˜ì • ë°©ë²•:"
      echo "  1. ë¬¸ì œ í™•ì¸: npm run lint:biome"
      echo "  2. ìˆ˜ë™ìœ¼ë¡œ ì½”ë“œ ìˆ˜ì •"
      echo "  3. ë‹¤ì‹œ git add í›„ ì»¤ë°‹"
      echo ""
      echo "âš ï¸ ìë™ ìˆ˜ì •(--write, --fix)ì€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
      exit 1
    }
  fi
else
  echo "  âš ï¸ Biome ì„¤ì • ì—†ìŒ - ê±´ë„ˆëœ€"
fi

echo "âœ… Pre-commit ê²€ì¦ í†µê³¼!"
echo ""
echo "ğŸ“Œ ì°¸ê³ ì‚¬í•­:"
echo "  - ëª¨ë“  ìë™ ìˆ˜ì • ê¸°ëŠ¥ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤"
echo "  - ë¬¸ì œ ë°œê²¬ ì‹œ ìˆ˜ë™ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤"
echo "  - ê²€ì¦ ê±´ë„ˆë›°ê¸°: git commit --no-verify -m \"message\""
echo ""

exit 0