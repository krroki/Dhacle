#!/bin/sh
# Pre-commit Hook v2.0 - 검증 전용 (자동 수정 없음)
# 2025-01-31: 모든 자동 수정 기능 제거, 검증만 수행

echo "🔍 Pre-commit 검증 시작..."

# 1단계: 빠른 핵심 검증
echo "📋 Step 1/4: 핵심 검증 실행 중..."
npm run verify:quick || {
  echo "❌ 핵심 검증 실패! 다음 문제를 수정하세요:"
  echo "  - API 인증 일치성 문제"
  echo "  - TypeScript 타입 안정성 문제"
  echo ""
  echo "💡 문제 확인 방법:"
  echo "  - API 검증: npm run verify:api"
  echo "  - 타입 검증: npm run verify:types"
  exit 1
}

# 2단계: TypeScript 컴파일 체크 (staged 파일만)
echo "📋 Step 2/4: TypeScript 컴파일 검증..."
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  echo "  검증 대상: $(echo $STAGED_TS_FILES | wc -w)개 파일"
  
  npx tsc --noEmit --skipLibCheck || {
    echo "❌ TypeScript 컴파일 오류!"
    echo ""
    echo "💡 해결 방법:"
    echo "  1. 타입 오류 확인: npm run types:check"
    echo "  2. DB 변경 시: npm run types:generate"
    echo "  3. 수동으로 타입 오류 수정"
    echo ""
    echo "⚠️ 자동 수정 도구는 제거되었습니다. 수동 수정이 필요합니다."
    exit 1
  }
fi

# 3단계: API Route 보안 검증 (staged API 파일만)
echo "📋 Step 3/4: API Route 보안 검증..."
STAGED_API_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/app/api/.*route\.(ts|tsx)$' || true)

if [ -n "$STAGED_API_FILES" ]; then
  echo "  API Route 변경 감지 - 보안 검증 실행"
  npm run verify:routes || {
    echo "❌ API Route 보안 검증 실패!"
    echo "  모든 API Route는 인증 체크가 필요합니다."
    echo ""
    echo "💡 올바른 패턴:"
    echo "  const { data: { user } } = await supabase.auth.getUser();"
    echo "  if (!user) {"
    echo "    return NextResponse.json("
    echo "      { error: 'User not authenticated' },"
    echo "      { status: 401 }"
    echo "    );"
    echo "  }"
    exit 1
  }
fi

# 4단계: Biome 코드 품질 검사 (검사만, 수정 없음)
echo "📋 Step 4/4: 코드 품질 검사..."
if [ -f "biome.json" ]; then
  STAGED_SRC_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'src/.*\.(ts|tsx|js|jsx)$' || true)
  
  if [ -n "$STAGED_SRC_FILES" ]; then
    echo "  Biome 검사 중... ($(echo $STAGED_SRC_FILES | wc -w)개 파일)"
    npx biome check $STAGED_SRC_FILES || {
      echo "⚠️ 코드 품질 이슈 발견!"
      echo ""
      echo "💡 수동 수정 방법:"
      echo "  1. 문제 확인: npm run lint:biome"
      echo "  2. 수동으로 코드 수정"
      echo "  3. 다시 git add 후 커밋"
      echo ""
      echo "⚠️ 자동 수정(--write, --fix)은 비활성화되었습니다."
      exit 1
    }
  fi
else
  echo "  ⚠️ Biome 설정 없음 - 건너뜀"
fi

echo "✅ Pre-commit 검증 통과!"
echo ""
echo "📌 참고사항:"
echo "  - 모든 자동 수정 기능이 제거되었습니다"
echo "  - 문제 발견 시 수동 수정이 필요합니다"
echo "  - 검증 건너뛰기: git commit --no-verify -m \"message\""
echo ""

exit 0